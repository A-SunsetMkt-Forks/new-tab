<div class="row">
  <label>Theme:</label>
  <select bind:value="pageTheme">
    <option value="d">Dark</option>
    <option value="">Light</option> <!-- default -->
  </select>
</div>

<div class="row">
  <label>List order:</label>
  <button on:click="resetOrder()">Reset</button>
  <ul>
    {#each resultsOrder as _item, index (_item)}
      <li
        class="item"
        draggable="true"
        on:dragstart="handleDragStart(event, index)"
        on:dragend="handleDragEnd(event)"
        on:dragover="handleDragOver(event)"
        on:dragenter="handleDragEnter(event)"
        on:dragleave="handleDragLeave(event)"
        on:drop="handleDrop(event, index)"
      >
        <span class="icon">â˜°</span>
        {_item}
      </li>
    {/each}
  </ul>
</div>

<script>
  import { DEFAULT_ORDER } from './common.js';

  export default {
    data: () => ({
      resultsOrder: [],
      pageTheme: '',
    }),
    oncreate() {
      // check existing settings
      chrome.storage.local.get(null, (settings) => {
        this.set({
          /* eslint-disable dot-notation */ // prevent closure mangling
          pageTheme: settings['t'],
          resultsOrder: settings['o'] || [...DEFAULT_ORDER],
          /* eslint-enable */
        });
      });
    },
    onstate({ current, previous }) {
      if (previous) {
        /* eslint-disable quote-props */ // prevent closure mangling
        chrome.storage.local.set({
          't': current.pageTheme,
          'o': JSON.stringify(current.resultsOrder) === JSON.stringify(DEFAULT_ORDER)
            ? null
            : current.resultsOrder,
        });
        /* eslint-enable */
      }
    },
    methods: {
      resetOrder() {
        this.set({ resultsOrder: [...DEFAULT_ORDER] });
      },

      moveItem(from, to) {
        const { resultsOrder } = this.get();
        const item = resultsOrder[from];

        // remove from previous location
        resultsOrder.splice(from, 1);

        // add to new location
        resultsOrder.splice(to, 0, item);

        this.set({ resultsOrder });
      },

      handleDragStart(event, index) {
        event.dataTransfer.setData('from', index);
        event.target.classList.add('dragging');
      },

      handleDragEnd(event) {
        event.target.classList.remove('dragging');
      },

      handleDragOver(event) {
        event.preventDefault();
        event.dataTransfer.dropEffect = 'move'; // eslint-disable-line no-param-reassign
      },

      handleDragEnter(event) {
        event.target.classList.add('over');
      },

      handleDragLeave(event) {
        event.target.classList.remove('over');
      },

      handleDrop(event, index) {
        event.preventDefault();
        const from = event.dataTransfer.getData('from');
        this.moveItem(from, index);

        // remove class in case the dragleave event didn't fire
        event.target.classList.remove('over');
      },
    },
  };
</script>

<style type="text/postcss">
  :global(body) {
    font-size: 18px;
  }

  :global(select),
  :global(button) {
    margin-left: 9px !important; /* stylelint-disable-line declaration-no-important */
  }

  :global(ul) {
    padding-left: 0;
    list-style: none;
  }

  :global(.row) {
    margin-bottom: 18px;
  }

  :global(.item) {
    padding: 6px 10px;
    margin: 6px 0;
    cursor: grab;
    border: 1px solid rgba(0, 0, 0, 0.25);
    border-radius: 2px;
  }

  :global(.icon) {
    margin-right: 10px;
    color: rgb(180, 180, 180);

    .item:hover > &,
    .item:focus > & {
      color: rgb(110, 110, 110);
    }
  }

  :global(.dragging) { /* stylelint-disable-line no-descending-specificity */
    border-style: dashed;
    opacity: 0.4;
  }

  :global(.over) { /* stylelint-disable-line no-descending-specificity */
    /* stylelint-disable-next-line declaration-no-important */
    border-color: rgb(21, 48, 167) !important;
  }
</style>
