<svelte:window on:resize="_setVisibleEnd()" />

<div id="bookmarks" ref:b>
  {#each _visible as _bookmark}
    <BookmarkItem _node="{_bookmark}" _lvl="{0}" />
  {/each}

  {#if _overflow.children.length}
    <BookmarkItem _node="{_overflow}" _lvl="{0}" _left/>
  {/if}

  {#if _bookmarksOther.children.length}
    <BookmarkItem _node="{_bookmarksOther}" _lvl="{0}" _left/>
  {/if}
</div>

<script>
  import BookmarkItem from './BookmarkItem.html';

  // Get title text width using the 2d canvas measureText method as it's
  // faster than adding an element to the DOM but we need to manually
  // calculate any padding etc.

  const FONT = '18px sans-serif';
  const TITLE_MAX_WIDTH = 144;
  const FAVICON_WIDTH = 16;
  const FAVICON_PADDING = 9;
  const ITEM_PADDING = 9 + 9; // padding left + right

  // reusing the same canvas is much faster
  const canvas = document.createElement('canvas').getContext('2d');
  canvas.font = FONT;
  const ellipsisWidth = canvas.measureText('…').width;
  const titleMaxInnerWidth = TITLE_MAX_WIDTH - ellipsisWidth;

  export default {
    components: {
      BookmarkItem,
    },
    data: () => ({
      _bookmarksBar: [],
      _bookmarksOther: { children: []},
      _end: 0,
    }),
    computed: {
      _visible: ({ _bookmarksBar, _end }) => _bookmarksBar.slice(0, _end),
      _overflow: ({ _bookmarksBar, _end }) => ({ title: '»', children: _bookmarksBar.slice(_end) }),
    },
    oncreate() {
      chrome.bookmarks.getTree((tree) => {
        this.set({
          _bookmarksBar: tree[0].children[0].children,
          _bookmarksOther: tree[0].children[1],
        });
      });
    },
    onstate({ changed, previous }) {
      if (previous === undefined) return;

      if (changed._bookmarksBar) {
        this._setVisibleEnd();
      }
    },
    methods: {
      _setVisibleEnd() {
        const { _bookmarksBar, _bookmarksOther } = this.get();
        const { length } = _bookmarksBar;
        const otherBookmarksWidth = !_bookmarksOther.children.length
          ? 0
          : canvas.measureText(_bookmarksOther.title).width + ITEM_PADDING;
        /* eslint-disable-next-line max-len */
        const bookmarksBarWidth = this.refs.b.offsetWidth - ITEM_PADDING - FAVICON_PADDING - otherBookmarksWidth;
        let _end = 0;
        let width = 0;

        /* eslint-disable-next-line no-plusplus */
        for (let index = 0; index !== length; index++) {
          const item = _bookmarksBar[index];
          /* eslint-disable-next-line no-nested-ternary */
          const faviconWidth = item.children
            ? 0
            : item.title
              ? FAVICON_WIDTH + FAVICON_PADDING
              : FAVICON_WIDTH;
          const realTitleWidth = item.title ? canvas.measureText(item.title).width : 0;
          const titleWidth = realTitleWidth > titleMaxInnerWidth ? TITLE_MAX_WIDTH : realTitleWidth;
          const itemWidth = ITEM_PADDING + faviconWidth + titleWidth;
          const newWidth = width + itemWidth;

          if (newWidth > bookmarksBarWidth) break;

          width = newWidth;
          _end = index + 1;
        }

        this.set({ _end });
      },
    },
  };
</script>

<style type="text/postcss" global>
  #bookmarks {
    position: fixed;
    top: 0;
    right: 0;
    left: 0;
    z-index: 2;
    display: flex;
    height: 41px;
    background: var(--c0);
    box-shadow: var(--s);
    backface-visibility: hidden; /* performance hack; force GPU */
  }
</style>
